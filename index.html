<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
  <meta name="theme-color" content="#000">
  <title>Vail Bus</title>
  <link rel="manifest" href="manifest.json">
  <link rel="apple-touch-icon" href="icon-192.png">
  <style>
    * { box-sizing: border-box; margin: 0; padding: 0; }
    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
      background: #000;
      color: #fff;
      min-height: 100vh;
      min-height: 100dvh;
      display: flex;
      flex-direction: column;
      padding: 16px;
      padding-top: max(16px, env(safe-area-inset-top));
      padding-bottom: max(16px, env(safe-area-inset-bottom));
    }
    header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 16px;
    }
    header h1 { font-size: 1.1rem; font-weight: 600; }
    .refresh {
      width: 36px; height: 36px;
      border: none; background: #222;
      color: #888; border-radius: 50%;
      font-size: 1.1rem; cursor: pointer;
    }
    .stops {
      display: flex;
      gap: 8px;
      margin-bottom: 20px;
    }
    .stop {
      flex: 1;
      padding: 10px 6px;
      border: 2px solid #333;
      border-radius: 10px;
      background: transparent;
      color: #666;
      font-size: 0.8rem;
      font-weight: 500;
      cursor: pointer;
      transition: all 0.15s;
    }
    .stop.active {
      border-color: #fff;
      color: #fff;
      background: #fff;
      color: #000;
    }
    .direction {
      display: flex;
      gap: 8px;
      margin-bottom: 24px;
    }
    .dir {
      flex: 1;
      padding: 8px;
      border: none;
      border-radius: 8px;
      background: #111;
      color: #666;
      font-size: 0.85rem;
      cursor: pointer;
    }
    .dir.active { background: #222; color: #fff; }

    .hero {
      flex: 1;
      display: flex;
      flex-direction: column;
      justify-content: center;
      align-items: center;
      text-align: center;
      padding: 20px 0;
    }
    .destination {
      font-size: 1rem;
      color: #888;
      margin-bottom: 8px;
    }
    .countdown {
      font-size: 7rem;
      font-weight: 700;
      line-height: 1;
      font-variant-numeric: tabular-nums;
      letter-spacing: -4px;
      transition: color 0.3s;
    }
    .countdown.green { color: #22c55e; }
    .countdown.yellow { color: #eab308; }
    .countdown.red { color: #ef4444; }
    .departs {
      margin-top: 12px;
      font-size: 1.1rem;
      color: #555;
    }
    .departs span { color: #888; }
    .after {
      margin-top: 6px;
      font-size: 0.95rem;
      color: #444;
    }
    .after span { color: #666; }
    .vibe {
      margin-top: 20px;
      font-size: 0.9rem;
      color: #555;
      font-style: italic;
    }

    .schedule-toggle {
      background: #111;
      border: none;
      color: #555;
      padding: 12px;
      border-radius: 10px;
      font-size: 0.9rem;
      cursor: pointer;
      margin-bottom: 12px;
    }
    .schedule-toggle.open { color: #888; }
    .schedule {
      display: none;
      background: #111;
      border-radius: 12px;
      padding: 12px;
      max-height: 200px;
      overflow-y: auto;
    }
    .schedule.open { display: block; }
    .times {
      display: grid;
      grid-template-columns: repeat(5, 1fr);
      gap: 6px;
    }
    .time {
      padding: 8px 4px;
      border-radius: 6px;
      text-align: center;
      font-size: 0.8rem;
      color: #555;
    }
    .time.next {
      background: #fff;
      color: #000;
      font-weight: 600;
    }
    .time.past { color: #333; }
    .time.future { color: #888; }
  </style>
</head>
<body>
  <header>
    <h1>üéø Slope Shuttle</h1>
    <button class="refresh" onclick="location.reload()">‚Üª</button>
  </header>

  <div class="stops">
    <button class="stop active" data-stop="eaglevail">EagleVail</button>
    <button class="stop" data-stop="avon">Avon</button>
    <button class="stop" data-stop="vail">Vail</button>
  </div>

  <div class="direction">
    <button class="dir active" data-dir="west">‚Üê Beaver Creek</button>
    <button class="dir" data-dir="east">Vail ‚Üí</button>
  </div>

  <div class="hero">
    <div class="destination" id="destination">to Beaver Creek</div>
    <div class="countdown green" id="countdown">--:--</div>
    <div class="departs">Departs <span id="departs">--:--</span></div>
    <div class="after">Then <span id="after">--:--</span></div>
    <div class="vibe" id="vibe"></div>
  </div>

  <button class="schedule-toggle" id="scheduleToggle">Show full schedule ‚ñº</button>
  <div class="schedule" id="schedule">
    <div class="times" id="times"></div>
  </div>

  <script>
    const schedules = {
      eaglevail: {
        west: ['5:38','6:23','6:43','7:03','7:23','7:43','8:03','8:23','8:43','9:03','9:23','9:43','10:03','10:23','10:43','11:03','11:23','11:43','12:03','12:23','12:43','13:03','13:23','13:43','14:03','14:23','14:43','15:03','15:23','15:33','15:43','16:03','16:23','16:33','16:43','17:03','17:23','17:33','17:43','18:03','18:23','18:53','19:23','19:53','20:23','20:53','21:23','21:53','22:23','22:53','23:23','23:53','0:23','0:53','1:23'],
        east: ['5:42','6:17','6:42','6:57','7:17','7:37','7:57','8:17','8:37','8:57','9:17','9:37','9:57','10:17','10:37','10:57','11:17','11:37','11:57','12:17','12:37','12:57','13:17','13:37','13:57','14:17','14:37','14:57','15:17','15:27','15:37','15:57','16:17','16:27','16:37','16:57','17:17','17:27','17:37','17:57','18:17','18:47','19:17','19:47','20:17','20:47','21:17','21:47','22:17','22:47','23:17','23:47','0:17','0:47','1:17']
      },
      avon: {
        west: ['5:46','6:28','6:48','7:08','7:28','7:48','8:08','8:28','8:48','9:08','9:28','9:48','10:08','10:28','10:48','11:08','11:28','11:48','12:08','12:28','12:48','13:08','13:28','13:48','14:08','14:28','14:48','15:08','15:28','15:38','15:48','16:08','16:28','16:38','16:48','17:08','17:28','17:38','17:48','18:08','18:28','18:58','19:28','19:58','20:28','20:58','21:28','21:58','22:28','22:58','23:28','23:58','0:28','0:58','1:28'],
        east: ['5:37','6:12','6:37','6:52','7:12','7:32','7:52','8:12','8:32','8:52','9:12','9:32','9:52','10:12','10:32','10:52','11:12','11:32','11:52','12:12','12:32','12:52','13:12','13:32','13:52','14:12','14:32','14:52','15:12','15:22','15:32','15:52','16:12','16:22','16:32','16:52','17:12','17:22','17:32','17:52','18:12','18:42','19:12','19:42','20:12','20:42','21:12','21:42','22:12','22:42','23:12','23:42','0:12','0:42','1:12']
      },
      vail: {
        west: ['5:25','6:05','6:25','6:45','7:05','7:25','7:45','8:05','8:25','8:45','9:05','9:25','9:45','10:05','10:25','10:45','11:05','11:25','11:45','12:05','12:25','12:45','13:05','13:25','13:45','14:05','14:25','14:45','15:05','15:15','15:20','15:25','15:45','16:05','16:15','16:20','16:25','16:45','17:05','17:15','17:20','17:25','17:45','18:05','18:35','19:05','19:35','20:05','20:35','21:05','21:35','22:05','22:35','23:05','23:35','0:05','0:35','1:05'],
        east: ['5:55','6:47','7:07','7:27','7:47','8:07','8:27','8:47','9:07','9:27','9:47','10:07','10:27','10:47','11:07','11:27','11:47','12:07','12:27','12:47','13:07','13:27','13:47','14:07','14:27','14:47','15:07','15:27','15:47','15:57','16:07','16:27','16:47','16:57','17:07','17:27','17:47','17:57','18:07','18:27','18:47','19:17','19:47','20:17','20:47','21:17','21:47','22:17','22:47','23:17','23:47','0:17','0:47','1:17','1:47']
      }
    };

    let currentStop = 'eaglevail';
    let currentDir = 'west';
    let nextBusSecs = null;
    let lastVibeLevel = null;
    let isGoingHome = false;

    const stopCoords = {
      eaglevail: { lat: 39.6254, lon: -106.5072, name: 'EagleVail' },
      avon: { lat: 39.6330, lon: -106.5222, name: 'Avon' },
      vail: { lat: 39.6423, lon: -106.3736, name: 'Vail' }
    };

    function getDistance(lat1, lon1, lat2, lon2) {
      const R = 3959;
      const dLat = (lat2 - lat1) * Math.PI / 180;
      const dLon = (lon2 - lon1) * Math.PI / 180;
      const a = Math.sin(dLat/2) * Math.sin(dLat/2) +
                Math.cos(lat1 * Math.PI / 180) * Math.cos(lat2 * Math.PI / 180) *
                Math.sin(dLon/2) * Math.sin(dLon/2);
      return R * 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a));
    }

    function detectNearestStop() {
      if (!navigator.geolocation) return;
      navigator.geolocation.getCurrentPosition(function(pos) {
        const lat = pos.coords.latitude;
        const lon = pos.coords.longitude;
        let nearest = null;
        let minDist = Infinity;

        for (const stop in stopCoords) {
          const d = getDistance(lat, lon, stopCoords[stop].lat, stopCoords[stop].lon);
          if (d < minDist) {
            minDist = d;
            nearest = stop;
          }
        }

        if (nearest && minDist < 1) {
          currentStop = nearest;
          currentDir = defaultDir[nearest];
          document.querySelectorAll('.stop').forEach(b => b.classList.remove('active'));
          document.querySelector('.stop[data-stop="' + nearest + '"]').classList.add('active');
          document.querySelectorAll('.dir').forEach(b => b.classList.remove('active'));
          document.querySelector('.dir[data-dir="' + currentDir + '"]').classList.add('active');
          render();
        }
      }, function(err) {
        console.log('Location unavailable');
      }, { timeout: 5000, maximumAge: 60000 });
    }

    const defaultDir = { eaglevail: 'west', avon: 'east', vail: 'west' };
    const showToggle = { eaglevail: true, avon: false, vail: false };
    const dirLabels = { west: 'to Beaver Creek üèîÔ∏è', east: 'to Vail üéø' };
    const homeDirLabel = 'heading home üè†';

    const skiVibes = {
      chill: [
        "Plenty of time. Grab a coffee ‚òï",
        "No rush. Fresh tracks await üéø",
        "Relax. The mountain isn't going anywhere",
        "Easy morning. Powder day vibes ‚ùÑÔ∏è"
      ],
      soon: [
        "Start walking. Goggle up! ü•Ω",
        "Time to move. Adventure calls",
        "Get going. First chair awaits ‚õ∑Ô∏è",
        "Wrap it up. Slopes are calling"
      ],
      now: [
        "Go go go! üèÉ",
        "Run for it! Fresh powder waits for no one",
        "Move it! The mountain is calling",
        "Hustle! Every second counts ‚è±Ô∏è"
      ]
    };

    const homeVibes = {
      chill: [
        "Take your time. Hot cocoa awaits ‚òï",
        "No rush. Couch is waiting üõãÔ∏è",
        "Relax. Home sweet home soon",
        "Good day on the slopes? üéø"
      ],
      soon: [
        "Start heading over",
        "Time to pack up",
        "One last run... or catch this bus",
        "Legs tired? Bus is coming"
      ],
      now: [
        "Go go go! üèÉ",
        "Run! Warm shower awaits üöø",
        "Move it! Dinner won't cook itself",
        "Hustle! Almost home ‚è±Ô∏è"
      ]
    };

    function getVibe(mins, goingHome) {
      const vibes = goingHome ? homeVibes : skiVibes;
      const list = mins >= 10 ? vibes.chill : mins >= 5 ? vibes.soon : vibes.now;
      return list[Math.floor(Math.random() * list.length)];
    }

    function toAmPm(t) {
      const [h, m] = t.split(':').map(Number);
      const suffix = h >= 12 && h < 24 ? 'p' : 'a';
      const hour = h % 12 || 12;
      return `${hour}:${m.toString().padStart(2, '0')}${suffix}`;
    }

    function getNowSecs() {
      const d = new Date();
      return d.getHours() * 3600 + d.getMinutes() * 60 + d.getSeconds();
    }

    function parseTimeSecs(t) {
      const [h, m] = t.split(':').map(Number);
      return h * 3600 + m * 60;
    }

    function updateCountdown() {
      if (!nextBusSecs) return;
      const now = getNowSecs();
      let diff = nextBusSecs - (now < 18000 ? now + 86400 : now);
      if (diff < 0) { render(); return; }

      const mins = Math.floor(diff / 60);
      const secs = diff % 60;
      const el = document.getElementById('countdown');

      if (mins >= 60) {
        const h = Math.floor(mins / 60);
        const m = mins % 60;
        el.textContent = `${h}:${m.toString().padStart(2,'0')}:${secs.toString().padStart(2,'0')}`;
      } else {
        el.textContent = `${mins}:${secs.toString().padStart(2,'0')}`;
      }

      const level = mins >= 10 ? 'green' : mins >= 5 ? 'yellow' : 'red';
      el.className = 'countdown ' + level;

      if (level !== lastVibeLevel) {
        lastVibeLevel = level;
        document.getElementById('vibe').textContent = getVibe(mins, isGoingHome);
      }
    }

    function render() {
      const times = schedules[currentStop][currentDir];
      const now = getNowSecs();
      const container = document.getElementById('times');

      let upcoming = [];

      times.forEach(t => {
        const secs = parseTimeSecs(t);
        let adjustedSecs = secs;
        if (secs < 18000) adjustedSecs += 86400;
        const diff = adjustedSecs - (now < 18000 ? now + 86400 : now);
        if (diff >= 0) upcoming.push({ t, adjustedSecs, diff });
      });

      upcoming.sort((a, b) => a.diff - b.diff);
      const nextTime = upcoming[0]?.t || null;
      const afterTime = upcoming[1]?.t || null;
      nextBusSecs = upcoming[0]?.adjustedSecs || null;

      container.innerHTML = times.map(t => {
        const secs = parseTimeSecs(t);
        let adjustedSecs = secs;
        if (secs < 18000) adjustedSecs += 86400;
        const diff = adjustedSecs - (now < 18000 ? now + 86400 : now);
        const isPast = diff < 0;
        const isNext = t === nextTime;

        let cls = 'time';
        if (isPast) cls += ' past';
        else if (isNext) cls += ' next';
        else cls += ' future';

        return `<div class="${cls}">${toAmPm(t)}</div>`;
      }).join('');

      isGoingHome = (currentStop === 'vail' && currentDir === 'west') ||
                    (currentStop === 'avon' && currentDir === 'east');
      document.getElementById('departs').textContent = nextTime ? toAmPm(nextTime) : '--:--';
      document.getElementById('after').textContent = afterTime ? toAmPm(afterTime) : '--:--';
      document.getElementById('destination').textContent = isGoingHome ? homeDirLabel : dirLabels[currentDir];

      if (!nextTime) {
        nextBusSecs = null;
        document.getElementById('countdown').textContent = '--:--';
        document.getElementById('countdown').className = 'countdown';
        document.getElementById('vibe').textContent = "That's a wrap for today üåô";
      } else {
        lastVibeLevel = null;
        updateCountdown();
      }

      document.querySelector('.direction').style.display = showToggle[currentStop] ? 'flex' : 'none';
    }

    document.querySelectorAll('.stop').forEach(btn => {
      btn.addEventListener('click', () => {
        document.querySelectorAll('.stop').forEach(b => b.classList.remove('active'));
        btn.classList.add('active');
        currentStop = btn.dataset.stop;
        currentDir = defaultDir[currentStop];
        document.querySelectorAll('.dir').forEach(b => b.classList.remove('active'));
        document.querySelector(`.dir[data-dir="${currentDir}"]`).classList.add('active');
        render();
      });
    });

    document.querySelectorAll('.dir').forEach(btn => {
      btn.addEventListener('click', () => {
        document.querySelectorAll('.dir').forEach(b => b.classList.remove('active'));
        btn.classList.add('active');
        currentDir = btn.dataset.dir;
        render();
      });
    });

    document.getElementById('scheduleToggle').addEventListener('click', () => {
      const sched = document.getElementById('schedule');
      const toggle = document.getElementById('scheduleToggle');
      const isOpen = sched.classList.toggle('open');
      toggle.classList.toggle('open', isOpen);
      toggle.textContent = isOpen ? 'Hide schedule ‚ñ≤' : 'Show full schedule ‚ñº';
    });

    render();
    setInterval(updateCountdown, 1000);
    detectNearestStop();
  </script>
</body>
</html>
